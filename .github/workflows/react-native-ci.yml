name: Reusable React Native CI

on:
  workflow_call:
    inputs:
      node_version:
        description: "Node.js version to use"
        type: string
        required: false
        default: "20"

      run_lint:
        description: "Run lint step if enabled"
        type: boolean
        required: false
        default: false

      run_tests:
        description: "Run tests step if enabled"
        type: boolean
        required: false
        default: false

      run_sonar:
        description: "Run SonarCloud analysis"
        type: boolean
        required: false
        default: false

      run_snyk:
        description: "Run Snyk dependency scan"
        type: boolean
        required: false
        default: false

      run_android_build:
        description: "Build Android debug APK (Expo prebuild + Gradle)"
        type: boolean
        required: false
        default: false

    secrets:
      SONAR_TOKEN:
        required: false
      SNYK_TOKEN:
        required: false

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  quality:
    name: quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package manager
        id: pm
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          elif [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ steps.pm.outputs.manager }}

      - name: Enable Corepack (for Yarn/PNPM)
        if: ${{ steps.pm.outputs.manager != 'npm' }}
        run: corepack enable

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          elif [ "${{ steps.pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          else
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci
            else
              npm install
            fi
          fi

      - name: Lint (only if enabled AND script exists)
        if: ${{ inputs.run_lint }}
        shell: bash
        run: |
          set -euo pipefail
          HAS_LINT="$(node -e "const p=require('./package.json'); console.log(p.scripts && p.scripts.lint ? 'true' : 'false')")"
          if [ "$HAS_LINT" = "true" ]; then
            echo "Running lint..."
            npm run lint
          else
            echo "run_lint=true but no 'lint' script found in package.json. Skipping."
          fi

      - name: Tests (only if enabled AND script exists)
        if: ${{ inputs.run_tests }}
        shell: bash
        run: |
          set -euo pipefail
          HAS_TEST="$(node -e "const p=require('./package.json'); console.log(p.scripts && p.scripts.test ? 'true' : 'false')")"
          if [ "$HAS_TEST" = "true" ]; then
            echo "Running tests..."
            npm test
          else
            echo "run_tests=true but no 'test' script found in package.json. Skipping."
          fi

  sonar:
    name: sonar
    runs-on: ubuntu-latest
    needs: [quality]
    if: ${{ inputs.run_sonar }}
    timeout-minutes: 20
    steps:
      - name: Fail if SONAR_TOKEN is missing
        shell: bash
        run: |
          if [ -z "${{ secrets.SONAR_TOKEN }}" ]; then
            echo "SONAR_TOKEN secret is missing. Add it to the calling repo, then pass it through workflow_call."
            exit 1
          fi

      - name: Checkout (full history recommended for Sonar)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sonar scan
        uses: SonarSource/sonarqube-scan-action@v6
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  snyk:
    name: snyk
    runs-on: ubuntu-latest
    needs: [quality]
    if: ${{ inputs.run_snyk }}
    timeout-minutes: 15
    steps:
      - name: Fail if SNYK_TOKEN is missing
        shell: bash
        run: |
          if [ -z "${{ secrets.SNYK_TOKEN }}" ]; then
            echo "SNYK_TOKEN secret is missing. Add it to the calling repo, then pass it through workflow_call."
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      # Faster than the docker-based node action, and matches your local CLI behavior
      - name: Setup Snyk CLI
        uses: snyk/actions/setup@master

      - name: Run Snyk (fail on >= medium)
        shell: bash
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          set -euo pipefail
          snyk --version
          snyk test --file=package-lock.json --severity-threshold=medium

  android-build:
    name: android-build
    runs-on: ubuntu-latest
    needs: [quality]
    if: ${{ inputs.run_android_build }}
    timeout-minutes: 45
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect package manager
        id: pm
        shell: bash
        run: |
          set -euo pipefail
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          elif [ -f yarn.lock ]; then
            echo "manager=yarn" >> "$GITHUB_OUTPUT"
          elif [ -f pnpm-lock.yaml ]; then
            echo "manager=pnpm" >> "$GITHUB_OUTPUT"
          else
            echo "manager=npm" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node_version }}
          cache: ${{ steps.pm.outputs.manager }}

      - name: Enable Corepack (for Yarn/PNPM)
        if: ${{ steps.pm.outputs.manager != 'npm' }}
        run: corepack enable

      - name: Install JS dependencies
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.pm.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          elif [ "${{ steps.pm.outputs.manager }}" = "pnpm" ]; then
            pnpm install --frozen-lockfile
          else
            npm ci
          fi

      - name: Expo prebuild (generate android/)
        shell: bash
        run: |
          set -euo pipefail
          npx expo prebuild --platform android --non-interactive

      - name: Setup Java (17)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Setup Gradle cache
        uses: gradle/actions/setup-gradle@v4

      - name: Ensure gradlew is executable
        run: chmod +x android/gradlew

      - name: Build Debug APK
        working-directory: android
        run: ./gradlew assembleDebug --no-daemon --stacktrace

      - name: Upload Debug APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-debug-apk
          path: android/app/build/outputs/apk/debug/app-debug.apk
